<!doctype html>
<html lang="zh"><head>
<title>2024网鼎杯青龙组REVERSE - Em_Lin</title>
<meta charset="UTF-8">
<meta name="keywords" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

<link rel="shortcut icon" href="https://c.img.dasctf.com/LightPicture/2024/09/0560a6b114c0b93c.png" type="image/png" />
<meta name="description" content="今年网鼎青龙组初赛的逆向题质量有点一般，而且只有两道。下面给出两道题的解析与复现。  REVERSE01这道题虽然是安卓题，但涉及到安卓相关的东西很少，而且只要静态分析就能解出，有点难绷…… 首先拿到APK去检测一下有没有加壳，发现没有壳，如下图：  JAVA层分析无壳，直接拖进jadx查看源码，如下图：  好好好，发现被混淆了，其实被混淆了也不用着急，因为一些方法还是能看出来，分析了一下，这里的">
<meta property="og:type" content="article">
<meta property="og:title" content="2024网鼎杯青龙组REVERSE">
<meta property="og:url" content="https://ermu0.cn/2024/11/05/reverse/ctf/2024wangdingctf-re/index.html">
<meta property="og:site_name" content="Em_Lin">
<meta property="og:description" content="今年网鼎青龙组初赛的逆向题质量有点一般，而且只有两道。下面给出两道题的解析与复现。  REVERSE01这道题虽然是安卓题，但涉及到安卓相关的东西很少，而且只要静态分析就能解出，有点难绷…… 首先拿到APK去检测一下有没有加壳，发现没有壳，如下图：  JAVA层分析无壳，直接拖进jadx查看源码，如下图：  好好好，发现被混淆了，其实被混淆了也不用着急，因为一些方法还是能看出来，分析了一下，这里的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/d30f4e51c526fae3.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/6df584c4fcd9ccef.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/4cb492a86197b272.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/4f1f06949de2b165.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/920a951aff641a77.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/9993f83f35a595a9.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/0b2b3f67123ea676.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/11/d3d6bd7e80832f7d.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/10/44383559dc619edd.png">
<meta property="og:image" content="https://c.img.dasctf.com/LightPicture/2024/10/2e3f958e35e833c5.png">
<meta property="article:published_time" content="2024-11-04T16:00:00.000Z">
<meta property="article:modified_time" content="2024-11-04T16:00:00.000Z">
<meta property="article:author" content="Em_Lin">
<meta property="article:tag" content="ctf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://c.img.dasctf.com/LightPicture/2024/11/d30f4e51c526fae3.png">

<link rel="stylesheet" href="/lib/fancybox/fancybox.css">
<link rel="stylesheet" href="/lib/mdui_043tiny/mdui.css">


<link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1730812651196">

<link rel="stylesheet" href="/css/style.css?v=1730812651196">




    
        <link rel="stylesheet" href="/custom.css?v=1730812651196">
    



<script src="/lib/mdui_043tiny/mdui.js" async></script>
<script src="/lib/fancybox/fancybox.umd.js" async></script>
<script src="/lib/lax.min.js" async></script>


<script async src="/js/app.js?v=1730812651196"></script>

 

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4D4ZJ9G024"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag("js", new Date());

  gtag("config", "G-4D4ZJ9G024");
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">


<link rel="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
<meta name="generator" content="Hexo 5.4.0"></head><body class="nexmoe mdui-drawer-body-left"><div id="nexmoe-background"><div class="nexmoe-bg" style="background-image: url(https://c.img.dasctf.com/LightPicture/2024/09/24b88941b6afcc33.png)"></div><div class="mdui-appbar mdui-shadow-0"><div class="mdui-toolbar"><a class="mdui-btn mdui-btn-icon mdui-ripple" mdui-drawer="{target: &#039;#drawer&#039;, swipe: true}" title="menu"><i class="mdui-icon nexmoefont icon-menu"></i></a><div class="mdui-toolbar-spacer"></div><a class="mdui-btn mdui-btn-icon" href="/" title="Em_Lin"><img src="https://c.img.dasctf.com/LightPicture/2024/09/0560a6b114c0b93c.png" alt="Em_Lin"></a></div></div></div><div id="nexmoe-header"><div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Em_Lin">
            <img src="https://c.img.dasctf.com/LightPicture/2024/09/0560a6b114c0b93c.png" alt="Em_Lin" alt="Em_Lin">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>13</div>
        <div><span>标签</span>5</div>
        <div><span>分类</span>3</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" target="_blank" rel="noopener" href="https://ermu0.github.io/2024/09/10/hello-world/" title="关于博主">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博主
            </div>
        </a>
        
    </div>
    
    
        
        <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:nexmoe.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>




    
        
        <div class="nexmoe-widget-wrap">
	<div class="nexmoe-widget nexmoe-social">
		<a
			class="mdui-ripple"
			href="https://nexmoe.com/3145B9F.html"
			target="_blank"
			mdui-tooltip="{content: 'QQ'}"
			style="
				color: rgb(249, 174, 8);
				background-color: rgba(249, 174, 8, .1);
			"
		>
			<i
				class="nexmoefont icon-QQ"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://space.bilibili.com/628727362"
			target="_blank"
			mdui-tooltip="{content: '哔哩哔哩'}"
			style="
				color: rgb(231, 106, 141);
				background-color: rgba(231, 106, 141, .1);
			"
		>
			<i
				class="nexmoefont icon-bilibili"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://github.com/ermu0/"
			target="_blank"
			mdui-tooltip="{content: 'GitHub'}"
			style="
				color: rgb(25, 23, 23);
				background-color: rgba(25, 23, 23, .1);
			"
		>
			<i
				class="nexmoefont icon-github"
			></i> </a
		><a
			class="mdui-ripple"
			href="https://nexmoe.com/atom.xml"
			target="_blank"
			mdui-tooltip="{content: 'RSS'}"
			style="
				color: rgb(247, 132, 34);
				background-color: rgba(247, 132, 34, .1);
			"
		>
			<i
				class="nexmoefont icon-rss"
			></i> </a
		>
	</div>
</div>

    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Android/">Android</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/加密算法/">加密算法</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/逆向/">逆向</a>
          <span class="category-list-count">5</span>
        </li>

        
      </ul>

    </div>
  </div>


    
        
        
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/DEX/" style="font-size: 10px;">DEX</a> <a href="/tags/ctf/" style="font-size: 10px;">ctf</a> <a href="/tags/shell/" style="font-size: 10px;">shell</a> <a href="/tags/tasks/" style="font-size: 20px;">tasks</a> <a href="/tags/%E7%AE%80%E4%BB%8B/" style="font-size: 10px;">简介</a>
    </div>
    
      <script>
        var maxTagcloud = parseInt(17);
        var tags_length = parseInt(5);
        var tags_arr = [];
        for(var i = 0; i < tags_length; i++){
          tags_arr.push(i);
        }
        tags_arr.sort(function (l, r) {
          return Math.random() > 0.5 ? -1 : 1;
        });
        tags_arr = tags_arr.slice(0, maxTagcloud < tags_length ? tags_length - maxTagcloud : 0);
        for(var tag_i = 0; tag_i < tags_arr.length; tag_i++){
          document.getElementById("randomtagcloud").children[tags_arr[tag_i]].style.display = 'none';
        }
      </script>
    
  </div>

    
        
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章归档</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">13</span></li></ul>
    </div>
  </div>



    
        
        
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">最新文章</h3>
    <div class="nexmoe-widget">
      <ul>
        
          <li>
            <a href="/2024/11/05/reverse/ctf/2024wangdingctf-re/">2024网鼎杯青龙组REVERSE</a>
          </li>
        
          <li>
            <a href="/2024/10/14/reverse/shell/vmp/01-vmp/">VMP逆向题分析</a>
          </li>
        
          <li>
            <a href="/2024/09/26/Android/01.DEX/">DEX文件格式（一）</a>
          </li>
        
          <li>
            <a href="/2024/09/18/algorithm/tea/">TEA</a>
          </li>
        
          <li>
            <a href="/2024/09/18/algorithm/aes/">AES</a>
          </li>
        
      </ul>
    </div>
  </div>

    
        
   
    <div class="nexmoe-copyright">
        &copy; 2024 Em_Lin
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href="https://beian.miit.gov.cn/">鄂ICP备2020018486号</a>

<!--这里可以自行更改    
<br><a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral">
<img src="https://i.dawnlab.me/c0268c1e6cfd0863d6ba35be1575941a.png" width="150px"></a>
-->    

    </div>
</div><!-- .nexmoe-drawer --></div><div id="nexmoe-content"><div class="nexmoe-primary"><div class="nexmoe-post">
  <article>
    
        <div class="nexmoe-post-cover"> 
            <img src="https://c.img.dasctf.com/LightPicture/2024/09/24b88941b6afcc33.png" alt="2024网鼎杯青龙组REVERSE" loading="lazy">
            <h1>2024网鼎杯青龙组REVERSE</h1>
        </div>
    
    
    <div class="nexmoe-post-meta">
    <div class="nexmoe-rainbow">
        <a class="nexmoefont icon-calendar-fill">2024年11月05日</a>
        
            <a class="nexmoefont icon-appstore-fill -link" href="/categories/%E9%80%86%E5%90%91/">逆向</a>
        
        
    </div>
    
    
    
    
    
</div>

    <p>今年网鼎青龙组初赛的逆向题质量有点一般，而且只有两道。下面给出两道题的解析与复现。</p>
<hr>
<h1 id="REVERSE01"><a href="#REVERSE01" class="headerlink" title="REVERSE01"></a>REVERSE01</h1><p>这道题虽然是安卓题，但涉及到安卓相关的东西很少，而且只要静态分析就能解出，有点难绷……</p>
<p>首先拿到APK去检测一下有没有加壳，发现没有壳，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/11/d30f4e51c526fae3.png" alt="APK查壳" data-caption="APK查壳" loading="lazy"></p>
<h2 id="JAVA层分析"><a href="#JAVA层分析" class="headerlink" title="JAVA层分析"></a>JAVA层分析</h2><p>无壳，直接拖进jadx查看源码，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/11/6df584c4fcd9ccef.png" alt="APK源码" data-caption="APK源码" loading="lazy"></p>
<p>好好好，发现被混淆了，其实被混淆了也不用着急，因为一些方法还是能看出来，分析了一下，这里的Main活动没有输入判断的逻辑。然后将APK放进模拟器运行一下，看有没有啥关键词（其实混淆后字符串之类的关键词大概率是搜不到的），发现输入错误后会有<strong>Toast</strong>提示，所以可以去搜索Toast关键词来找到输入判断的地方。</p>
<p>果然，用Toast当关键词搜索有用，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/11/4cb492a86197b272.png" alt="输入判断" data-caption="输入判断" loading="lazy"></p>
<p>发现我们的输入先进行了一个是否为空的判断后，再进入了一个Check类的validate方法中去进行最终判断，如果正确就提示正确信息，否则就提示输入错误。</p>
<p>而Check类下的validate是一个<strong>native</strong>方法，所以解题关键是在<strong>so文件</strong>中逆向该方法。</p>
<h2 id="Native函数分析"><a href="#Native函数分析" class="headerlink" title="Native函数分析"></a>Native函数分析</h2><p><strong>libcma.so</strong>文件拿去ida分析后，发现这个函数名也被混淆了，就是被拿去<strong>JNI_OnLoad</strong>函数中动态注册了，进注册表中看注册的函数名，发现validate被映射到了一个叫做<strong>sub_75C</strong>的函数，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/11/4f1f06949de2b165.png" alt="注册表" data-caption="注册表" loading="lazy"></p>
<p>所以进入sub_75C函数去查看逻辑，如下图：</p>
<p><img src="https://c.img.dasctf.com/LightPicture/2024/11/920a951aff641a77.png"></p>
<p><img src="https://c.img.dasctf.com/LightPicture/2024/11/9993f83f35a595a9.png"></p>
<p><strong>先给出结论，整个sub_75C函数包括了SM4密钥扩展和SM4加密，下面给出分析。</strong></p>
<h3 id="SM4密钥扩展"><a href="#SM4密钥扩展" class="headerlink" title="SM4密钥扩展"></a>SM4密钥扩展</h3><p>先来看下<strong>密钥扩展</strong>部分的代码也就是<strong>sub_904</strong>函数，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/11/0b2b3f67123ea676.png" alt="密钥扩展" data-caption="密钥扩展" loading="lazy"></p>
<p>为什么看出来这个算法是SM4，而不是其它什么算法，就是因为在SM4的密钥扩展中有两个不变的参数，一个是<strong>系统参数FK</strong>，另一个是<strong>固定参数CK</strong>。从这里就可以基本判断出这是一个SM4加密算法。</p>
<p>其中FK共有4个，每个都有4字节长，它们的值如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FK = [<span class="number">0xa3b1bac6</span>, <span class="number">0x56aa3350</span>, <span class="number">0x677d9197</span>, <span class="number">0xb27022dc</span>]</span><br></pre></td></tr></table></figure>

<p>而CK共有32个，每个同样有4字节长，它们的值如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CK = [</span><br><span class="line">    <span class="number">0x00070e15</span>, <span class="number">0x1c232a31</span>, <span class="number">0x383f464d</span>, <span class="number">0x545b6269</span>,</span><br><span class="line">    <span class="number">0x70777e85</span>, <span class="number">0x8c939aa1</span>, <span class="number">0xa8afb6bd</span>, <span class="number">0xc4cbd2d9</span>,</span><br><span class="line">    <span class="number">0xe0e7eef5</span>, <span class="number">0xfc030a11</span>, <span class="number">0x181f262d</span>, <span class="number">0x343b4249</span>,</span><br><span class="line">    <span class="number">0x50575e65</span>, <span class="number">0x6c737a81</span>, <span class="number">0x888f969d</span>, <span class="number">0xa4abb2b9</span>,</span><br><span class="line">    <span class="number">0xc0c7ced5</span>, <span class="number">0xdce3eaf1</span>, <span class="number">0xf8ff060d</span>, <span class="number">0x141b2229</span>,</span><br><span class="line">    <span class="number">0x30373e45</span>, <span class="number">0x4c535a61</span>, <span class="number">0x686f767d</span>, <span class="number">0x848b9299</span>,</span><br><span class="line">    <span class="number">0xa0a7aeb5</span>, <span class="number">0xbcc3cad1</span>, <span class="number">0xd8dfe6ed</span>, <span class="number">0xf4fb0209</span>,</span><br><span class="line">    <span class="number">0x10171e25</span>, <span class="number">0x2c333a41</span>, <span class="number">0x484f565d</span>, <span class="number">0x646b7279</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>关于CK的值，这里要提一句，ida反编译出来的伪C出来的CK‘值如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">unsigned <span class="built_in">int</span> unk_C44[<span class="number">32</span>] = &#123;</span><br><span class="line">    <span class="number">0x00070E12</span>, <span class="number">0x1C232A36</span>, <span class="number">0x383F464A</span>, <span class="number">0x545B626E</span>, </span><br><span class="line">    <span class="number">0x70777E82</span>, <span class="number">0x8C939AA6</span>, <span class="number">0xA8AFB6BA</span>, <span class="number">0xC4CBD2DE</span>, </span><br><span class="line">    <span class="number">0xE0E7EEF2</span>, <span class="number">0xFC030A16</span>, <span class="number">0x181F262A</span>, <span class="number">0x343B424E</span>, </span><br><span class="line">    <span class="number">0x50575E62</span>, <span class="number">0x6C737A86</span>, <span class="number">0x888F969A</span>, <span class="number">0xA4ABB2BE</span>, </span><br><span class="line">    <span class="number">0xC0C7CED2</span>, <span class="number">0xDCE3EAF6</span>, <span class="number">0xF8FF060A</span>, <span class="number">0x141B222E</span>, </span><br><span class="line">    <span class="number">0x30373E42</span>, <span class="number">0x4C535A66</span>, <span class="number">0x686F767A</span>, <span class="number">0x848B929E</span>, </span><br><span class="line">    <span class="number">0xA0A7AEB2</span>, <span class="number">0xBCC3CAD6</span>, <span class="number">0xD8DFE6EA</span>, <span class="number">0xF4FB020E</span>, </span><br><span class="line">    <span class="number">0x10171E22</span>, <span class="number">0x2C333A46</span>, <span class="number">0x484F565A</span>, <span class="number">0x646B727E</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>很明显CK’不是CK，但是要注意，ida中是将CK‘异或了7，异或了7之后就会发现，变成了原CK的值。类似的异或在后面的SM4加密环节中还会再出现一次。</p>
<p>因此判断出了这是SM4的密钥扩展之后，只需要找到原密钥即可。而原密钥在该函数的开头就已经给出，这里只需要注意替换后8字节数据时，ida是小端序输入，所以需要将<code>Z0099864</code>倒叙替换。</p>
<p>所以原密钥**<code>key = 4131313232333537343638393930305A</code>**（我这里已经写成了十六进制形式）</p>
<h3 id="SM4轮函数"><a href="#SM4轮函数" class="headerlink" title="SM4轮函数"></a>SM4轮函数</h3><p>继续分析<strong>主加密函数</strong>sub_A0C，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/11/d3d6bd7e80832f7d.png" alt="主加密函数" data-caption="主加密函数" loading="lazy"></p>
<p>这里面的代码我详细说明中间的循环部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v11 = v8;                                   <span class="comment">// 1</span></span><br><span class="line">    v8 = v10;                                   <span class="comment">// 2</span></span><br><span class="line">    v10 = v9;                                   <span class="comment">// 3</span></span><br><span class="line">    v12 = v8 ^ v11 ^ v9 ^ *(_DWORD *)(a1 + i);  <span class="comment">// 将1、2、3，这个三组32位数据异或，然后再与密钥异或</span></span><br><span class="line">    v13 = byte_CC4[HIBYTE(v12)] ^ <span class="number">7</span>;            <span class="comment">// 此时异或结果为32位，然后再拿进S盒中变换</span></span><br><span class="line">    v14 = (v13 &lt;&lt; <span class="number">24</span>) | ((byte_CC4[BYTE2(v12)] ^ <span class="number">7</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">    v15 = v14 &amp; <span class="number">0xFFFF00FF</span> | ((byte_CC4[BYTE1(v12)] ^ <span class="number">7</span>) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">    v16 = v15 &amp; <span class="number">0xFFFFFF00</span> | byte_CC4[(<span class="keyword">unsigned</span> __int8)v12] ^ <span class="number">7</span>;<span class="comment">// 这几行的&amp;也好和后面的|也好，还有左移&lt;&lt;，都是是进行拼接的意思，其含义就是将从S表中变换后的数据^7之后再重新拼接成32位数据</span></span><br><span class="line">    HIDWORD(v17) = byte_CC4[(<span class="keyword">unsigned</span> __int8)v12] ^ <span class="number">7</span>;<span class="comment">// 猜测这两行代码应该是循环左移24位的意思</span></span><br><span class="line">                                                <span class="comment">// v17 = v16 &lt;&lt;&lt; 24</span></span><br><span class="line">    LODWORD(v17) = v15;</span><br><span class="line">    v9 = v16 ^ v7 ^ (v17 &gt;&gt; <span class="number">8</span>) ^ ((v13 &gt;&gt; <span class="number">6</span>) | (<span class="number">4</span> * v16)) ^ (__PAIR64__(v16, v14) &gt;&gt; <span class="number">22</span>) ^ (__PAIR64__(v16, v15) &gt;&gt; <span class="number">14</span>);<span class="comment">// md，ida的编译真的痛苦，分析出来就是原SM4的L加密</span></span><br><span class="line">    *(_DWORD *)&amp;v22[i] = v9;</span><br><span class="line">    i += <span class="number">4LL</span>;</span><br><span class="line">    v7 = v11;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( i != <span class="number">128</span> );                           <span class="comment">// 32轮加密</span></span><br></pre></td></tr></table></figure>

<p>讲解之前最好对SM4算法有一定了解，可以去看一下这篇<a target="_blank" rel="noopener" href="https://www.cnblogs.com/11sgXL/p/13626483.html">帖子</a>。</p>
<p><em><strong>1）</strong></em>首先来看一下这几行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v11 = v8;                                   <span class="comment">// 1</span></span><br><span class="line">  v8 = v10;                                   <span class="comment">// 2</span></span><br><span class="line">  v10 = v9;                                   <span class="comment">// 3</span></span><br><span class="line">  v12 = v8 ^ v11 ^ v9 ^ *(_DWORD *)(a1 + i); </span><br></pre></td></tr></table></figure>

<p>这里ida有点混乱，<strong>实际</strong>上应该如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> str[<span class="number">0</span>] = input[<span class="number">0</span>]; <span class="comment">//这里都用4字节int型来装填数据，因为SM4要求输入必须是128bit</span></span><br><span class="line"><span class="keyword">int</span> str[<span class="number">1</span>] = input[<span class="number">1</span>]; <span class="comment">//而SM4在加密时会分成4组4字节数据来进行加密操作</span></span><br><span class="line"><span class="keyword">int</span> str[<span class="number">2</span>] = input[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">int</span> str[<span class="number">3</span>] = input[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">temp = str[<span class="number">1</span>] ^ str[<span class="number">2</span>] ^ str[<span class="number">3</span>] ^ key[i]; <span class="comment">//SM4每一加密轮的首组4字节数据只会在每一轮的最后参与运算，而每一加密的密钥都不相同。最后temp为32bit数据</span></span><br></pre></td></tr></table></figure>



<p><em><strong>2）</strong></em>再来看这几行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v13 = byte_CC4[HIBYTE(v12)] ^ <span class="number">7</span>;            <span class="comment">// 此时异或结果为32位，然后再拿进S盒中变换</span></span><br><span class="line">  v14 = (v13 &lt;&lt; <span class="number">24</span>) | ((byte_CC4[BYTE2(v12)] ^ <span class="number">7</span>) &lt;&lt; <span class="number">16</span>);</span><br><span class="line">  v15 = v14 &amp; <span class="number">0xFFFF00FF</span> | ((byte_CC4[BYTE1(v12)] ^ <span class="number">7</span>) &lt;&lt; <span class="number">8</span>);</span><br><span class="line">  v16 = v15 &amp; <span class="number">0xFFFFFF00</span> | byte_CC4[(<span class="keyword">unsigned</span> __int8)v12] ^ <span class="number">7</span>;<span class="comment">// 这几行的&amp;也好和后面的|也好，还有左移&lt;&lt;，都是是进行拼接的意思，其含义就是将从S表中变换后的数据^7之后再重新拼接成32位数据</span></span><br></pre></td></tr></table></figure>

<p>这里ida也反编译得很乱，<strong>实际</strong>上应该如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">temp[<span class="number">0</span>] = S[temp[<span class="number">0</span>]&amp;<span class="number">0xF0</span>][temp[<span class="number">0</span>]&amp;<span class="number">0x0F</span>] ^ <span class="number">7</span>; <span class="comment">//也就是将32bit的temp，再次分成4组8bit数据，然后将每组8bit中的高4位做为行，低4位作为列，然后拿这个当成坐标去S这个表中去寻值，最后将寻到的值再异或7之后重新赋给temp[0]，而这里的异或也是本题对SM4算法的改动之一（异或完之后，会发现就是原SM4的S盒）</span></span><br><span class="line">temp[<span class="number">1</span>] = S[temp[<span class="number">1</span>]&amp;<span class="number">0xF0</span>][temp[<span class="number">1</span>]&amp;<span class="number">0x0F</span>] ^ <span class="number">7</span>;</span><br><span class="line">temp[<span class="number">2</span>] = S[temp[<span class="number">2</span>]&amp;<span class="number">0xF0</span>][temp[<span class="number">2</span>]&amp;<span class="number">0x0F</span>] ^ <span class="number">7</span>;</span><br><span class="line">temp[<span class="number">3</span>] = S[temp[<span class="number">3</span>]&amp;<span class="number">0xF0</span>][temp[<span class="number">3</span>]&amp;<span class="number">0x0F</span>] ^ <span class="number">7</span>;</span><br></pre></td></tr></table></figure>

<p>你问我为什么是怎么还原这里的逻辑的，拿草稿自己算一遍：由于v13在ida中是一个int8类型的数据，v14、v15、v16都是int类型，同时<code>HIBYTE(v12)</code>的意思是取最高8位的数据，<code>BYTE2(v12)</code>是取次高8位数据，<code>byte_CC4[BYTE1(v12)</code>以此类推是取次低8位数据，<code>(unsigned __int8)v12</code>是取最低8位数据，其次当v13左移24位时，不就是将它的8位数据移到32位（因为v14是int类型）的最高8位嘛，然后将该数据<code>或运算|</code> 一个左移16位的数据，就是将该8位数据与前8位数据拼接在一起组成32位数据的前16位……所以拿草稿自己模拟一遍，逻辑就很清晰了。后两行代码逻辑和前面一样都是拼接逻辑，然后组成一个新32位数据。</p>
<p><em><strong>3）</strong></em>接着再看这几行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HIDWORD(v17) = byte_CC4[(<span class="keyword">unsigned</span> __int8)v12] ^ <span class="number">7</span>;<span class="comment">// 我猜测这两行代码应该是循环左移24位的意思, v17 = v16 &lt;&lt;&lt; 24</span></span><br><span class="line">   LODWORD(v17) = v15;</span><br><span class="line">   v9 = v16 ^ v7 ^ (v17 &gt;&gt; <span class="number">8</span>) ^ ((v13 &gt;&gt; <span class="number">6</span>) | (<span class="number">4</span> * v16)) ^ (__PAIR64__(v16, v14) &gt;&gt; <span class="number">22</span>) ^ (__PAIR64__(v16, v15) &gt;&gt; <span class="number">14</span>);<span class="comment">// md，ida的编译真的痛苦，分析出来就是原SM4的L加密（这里的代码看汇编会更容易分析）</span></span><br></pre></td></tr></table></figure>

<p>这里的代码相当鬼，ida的反编译有时候就是这么痛苦，明明一个简单的代码都能被编译成这个样子……</p>
<p>这里的逻辑大致梳理一下：v17是一个int64类型的数据，对比我上面写的temp，大概就是将原32位数据<code>temp[0]、temp[1]、temp[2]、temp[3]</code>，调换原最低8位数据位置到现高32位的最低8位，即<strong>变成</strong>如下：</p>
<p><code>0、0、0、temp[3]、temp[0]、temp[1]、temp[2]、0</code>，这样的64位数据，其中0代表整个字节都为0，然后再将该数据也就是v17右移8位，也就是<strong>变成</strong>如下：</p>
<p><code>0、0、0、0、temp[3]、temp[0]、temp[1]、temp[2]</code>，这样的64位数据，说白了就是将原32位temp循环左移24位，即：**<code>temp&lt;&lt;&lt;24</code>**。</p>
<p>同样的后面的<code>((v13 &gt;&gt; 6) | (4 * v16))</code>，就是将temp循环左移2位，即：**<code>temp&lt;&lt;&lt;2</code>**。</p>
<p>而<code>(__PAIR64__(v16, v14) &gt;&gt; 22)</code>，就是将temp循环左移10位，即：**<code>temp&lt;&lt;&lt;10</code>**，这里要说明一下<code>(__PAIR64__(v16, v14) &gt;&gt; 22)</code>是什么意思，这里是ida的特殊写法，它的等效代码可以写做如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> combined = ((<span class="keyword">uint64_t</span>)v16 &lt;&lt; <span class="number">32</span>) | v14;</span><br><span class="line"><span class="keyword">uint64_t</span> result = combined &gt;&gt; <span class="number">22</span>;</span><br></pre></td></tr></table></figure>

<p>这里还是要拿草稿计算一下，由于这里被转成了64位数据，所以最后还需要将上述过程形成的64位数据重新转成32位，也就是说高位数据<strong>多出的</strong>部分<strong>要丢弃</strong>。</p>
<p>最后的<code>(__PAIR64__(v16, v15) &gt;&gt; 14)</code>，就是将temp循环左移18位，即：**<code>temp&lt;&lt;&lt;18</code>**。</p>
<p>所以第3部分的代码<strong>实际</strong>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_temp_ = str[<span class="number">0</span>] ^ temp ^ (temp&lt;&lt;&lt;<span class="number">2</span>) ^ (temp&lt;&lt;&lt;<span class="number">10</span>) ^ (temp&lt;&lt;&lt;<span class="number">18</span>) ^ (temp&lt;&lt;&lt;<span class="number">24</span>);</span><br></pre></td></tr></table></figure>



<p><em><strong>4）</strong></em>最后再来看这部分的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*(_DWORD *)&amp;v22[i] = v9;</span><br><span class="line">  i += <span class="number">4LL</span>;</span><br><span class="line">  v7 = v11;</span><br></pre></td></tr></table></figure>

<p>这部分的代码包括了循环递增以及数据的偏移变化，上面也说了我们的输入是128bit，而每一轮加密结束都会新增一个32位数据到原数据的末尾，为了确保每一轮加密都是128bit，所以每一轮加密后，待加密数据都会向后偏移32bit。举个例子：</p>
<p>第一轮待加密数据如下：（每个str[]都是32bit数据）</p>
<p><code>str[0] str[1] str[2] str[3]</code></p>
<p>第一轮加密结束后的数据如下：</p>
<p><code>str[0] str[1] str[2] str[3] Str[4]</code>，其中<code>str[4]</code>是第一轮加密结果</p>
<p>第二轮待加密数据如下：（每轮加密结束后向后移动32bit）</p>
<p><code>str[1] str[2] str[3] Str[4]</code></p>
<p>以此类推……执行32轮加密，取最后4个32bit数据，再倒序，作为加密结果。</p>
<h2 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h2><p>最后需要比对的正确密文在ida解析后也不难找到，<strong>正确的密文</strong>内容如下：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A27C84EDE57F4EDE9D977F6C69339F2752E6067920A2C3B7A6BE2B4A6231650C51160EF0A39807DD8F40CF021D482310</span><br></pre></td></tr></table></figure>

<p>剩下的就只有解密了，最后附上一个SM4解密脚本：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">S_BOX = [<span class="number">0xd1</span>, <span class="number">0x97</span>, <span class="number">0xee</span>, <span class="number">0xf9</span>, <span class="number">0xcb</span>, <span class="number">0xe6</span>, <span class="number">0x3a</span>, <span class="number">0xb0</span>, <span class="number">0x11</span>, <span class="number">0xb1</span>, <span class="number">0x13</span>, <span class="number">0xc5</span>, <span class="number">0x2f</span>, <span class="number">0xfc</span>, <span class="number">0x2b</span>, <span class="number">0x2</span>, <span class="number">0x2c</span>, <span class="number">0x60</span>, <span class="number">0x9d</span>, <span class="number">0x71</span>, <span class="number">0x2d</span>, <span class="number">0xb9</span>, <span class="number">0x3</span>, <span class="number">0xc4</span>, <span class="number">0xad</span>, <span class="number">0x43</span>, <span class="number">0x14</span>, <span class="number">0x21</span>, <span class="number">0x4e</span>, <span class="number">0x81</span>, <span class="number">0x1</span>, <span class="number">0x9e</span>, <span class="number">0x9b</span>, <span class="number">0x45</span>, <span class="number">0x57</span>, <span class="number">0xf3</span>, <span class="number">0x96</span>, <span class="number">0xe8</span>, <span class="number">0x9f</span>, <span class="number">0x7d</span>, <span class="number">0x34</span>, <span class="number">0x53</span>, <span class="number">0xc</span>, <span class="number">0x44</span>, <span class="number">0xea</span>, <span class="number">0xc8</span>, <span class="number">0xab</span>, <span class="number">0x65</span>, <span class="number">0xe3</span>, <span class="number">0xb4</span>, <span class="number">0x1b</span>, <span class="number">0xae</span>, <span class="number">0xce</span>, <span class="number">0xf</span>, <span class="number">0xef</span>, <span class="number">0x92</span>, <span class="number">0x87</span>, <span class="number">0xd8</span>, <span class="number">0x93</span>, <span class="number">0xfd</span>, <span class="number">0x72</span>, <span class="number">0x88</span>, <span class="number">0x38</span>, <span class="number">0xa1</span>, <span class="number">0x40</span>, <span class="number">0x0</span>, <span class="number">0xa0</span>, <span class="number">0xfb</span>, <span class="number">0xf4</span>, <span class="number">0x74</span>, <span class="number">0x10</span>, <span class="number">0xbd</span>, <span class="number">0x84</span>, <span class="number">0x5e</span>, <span class="number">0x3b</span>, <span class="number">0x1e</span>, <span class="number">0xe1</span>, <span class="number">0x82</span>, <span class="number">0x48</span>, <span class="number">0xaf</span>, <span class="number">0x6f</span>, <span class="number">0x6c</span>, <span class="number">0x86</span>, <span class="number">0xb5</span>, <span class="number">0x76</span>, <span class="number">0x63</span>, <span class="number">0xdd</span>, <span class="number">0x8c</span>, <span class="number">0xff</span>, <span class="number">0xec</span>, <span class="number">0x8</span>, <span class="number">0x4c</span>, <span class="number">0x77</span>, <span class="number">0x51</span>, <span class="number">0x9a</span>, <span class="number">0x32</span>, <span class="number">0x19</span>, <span class="number">0x23</span>, <span class="number">0x9</span>, <span class="number">0x59</span>, <span class="number">0x64</span>, <span class="number">0x5f</span>, <span class="number">0xd6</span>, <span class="number">0xa5</span>, <span class="number">0x22</span>, <span class="number">0x25</span>, <span class="number">0x7b</span>, <span class="number">0x3c</span>, <span class="number">0x6</span>, <span class="number">0x26</span>, <span class="number">0x7f</span>, <span class="number">0x80</span>, <span class="number">0xd3</span>, <span class="number">0x7</span>, <span class="number">0x41</span>, <span class="number">0x50</span>, <span class="number">0x98</span>, <span class="number">0xd4</span>, <span class="number">0x20</span>, <span class="number">0x55</span>, <span class="number">0x4b</span>, <span class="number">0x31</span>, <span class="number">0x5</span>, <span class="number">0xe0</span>, <span class="number">0xa7</span>, <span class="number">0xc3</span>, <span class="number">0xcf</span>, <span class="number">0x99</span>, <span class="number">0xed</span>, <span class="number">0xb8</span>, <span class="number">0x8d</span>, <span class="number">0xd5</span>, <span class="number">0x47</span>, <span class="number">0xc0</span>, <span class="number">0x3f</span>, <span class="number">0xb2</span>, <span class="number">0xa4</span>, <span class="number">0xf0</span>, <span class="number">0xf5</span>, <span class="number">0xc9</span>, <span class="number">0xfe</span>, <span class="number">0x66</span>, <span class="number">0x12</span>, <span class="number">0xa6</span>, <span class="number">0xe7</span>, <span class="number">0xa9</span>, <span class="number">0x5a</span>, <span class="number">0xa3</span>, <span class="number">0x9c</span>, <span class="number">0x33</span>, <span class="number">0x1d</span>, <span class="number">0x52</span>, <span class="number">0xaa</span>, <span class="number">0x94</span>, <span class="number">0x35</span>, <span class="number">0x37</span>, <span class="number">0xf2</span>, <span class="number">0x8b</span>, <span class="number">0xb6</span>, <span class="number">0xe4</span>, <span class="number">0x1a</span>, <span class="number">0xf1</span>, <span class="number">0xe5</span>, <span class="number">0x29</span>, <span class="number">0x85</span>, <span class="number">0x61</span>, <span class="number">0xcd</span>, <span class="number">0x67</span>, <span class="number">0xc7</span>, <span class="number">0x2e</span>, <span class="number">0x24</span>, <span class="number">0xac</span>, <span class="number">0xa</span>, <span class="number">0x54</span>, <span class="number">0x49</span>, <span class="number">0x68</span>, <span class="number">0xd2</span>, <span class="number">0xdc</span>, <span class="number">0x30</span>, <span class="number">0x42</span>, <span class="number">0xd9</span>, <span class="number">0xfa</span>, <span class="number">0x89</span>, <span class="number">0x28</span>, <span class="number">0x4</span>, <span class="number">0xf8</span>, <span class="number">0x6d</span>, <span class="number">0x75</span>, <span class="number">0x6a</span>, <span class="number">0x6b</span>, <span class="number">0x5c</span>, <span class="number">0x56</span>, <span class="number">0x8a</span>, <span class="number">0x1c</span>, <span class="number">0xa8</span>, <span class="number">0x95</span>, <span class="number">0xbc</span>, <span class="number">0xda</span>, <span class="number">0xbb</span>, <span class="number">0x78</span>, <span class="number">0x16</span>, <span class="number">0xde</span>, <span class="number">0x5b</span>, <span class="number">0x46</span>, <span class="number">0x18</span>, <span class="number">0x17</span>, <span class="number">0x5d</span>, <span class="number">0xdf</span>, <span class="number">0xd</span>, <span class="number">0xc6</span>, <span class="number">0x36</span>, <span class="number">0x8f</span>, <span class="number">0xa2</span>, <span class="number">0xca</span>, <span class="number">0x7c</span>, <span class="number">0xba</span>, <span class="number">0x2a</span>, <span class="number">0x73</span>, <span class="number">0xd7</span>, <span class="number">0x15</span>, <span class="number">0xbf</span>, <span class="number">0xe2</span>, <span class="number">0xb3</span>, <span class="number">0xb7</span>, <span class="number">0x8e</span>, <span class="number">0x6e</span>, <span class="number">0x90</span>, <span class="number">0x4d</span>, <span class="number">0xb</span>, <span class="number">0x91</span>, <span class="number">0x70</span>, <span class="number">0x79</span>, <span class="number">0x62</span>, <span class="number">0xbe</span>, <span class="number">0xf6</span>, <span class="number">0xe</span>, <span class="number">0xc2</span>, <span class="number">0x69</span>, <span class="number">0xc1</span>, <span class="number">0x83</span>, <span class="number">0x1f</span>, <span class="number">0xf7</span>, <span class="number">0x7a</span>, <span class="number">0xeb</span>, <span class="number">0x3d</span>, <span class="number">0xdb</span>, <span class="number">0x4a</span>, <span class="number">0x27</span>, <span class="number">0x7e</span>, <span class="number">0xe9</span>, <span class="number">0x58</span>, <span class="number">0x39</span>, <span class="number">0xd0</span>, <span class="number">0xcc</span>, <span class="number">0x3e</span>, <span class="number">0x4f</span>]</span><br><span class="line"><span class="comment"># 换为S盒</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(S_BOX)):</span><br><span class="line">    S_BOX[i] ^= <span class="number">7</span></span><br><span class="line"></span><br><span class="line">FK = [<span class="number">0xa3b1bac6</span>, <span class="number">0x56aa3350</span>, <span class="number">0x677d9197</span>, <span class="number">0xb27022dc</span>]</span><br><span class="line">CK = [</span><br><span class="line">    <span class="number">0x00070e15</span>, <span class="number">0x1c232a31</span>, <span class="number">0x383f464d</span>, <span class="number">0x545b6269</span>,</span><br><span class="line">    <span class="number">0x70777e85</span>, <span class="number">0x8c939aa1</span>, <span class="number">0xa8afb6bd</span>, <span class="number">0xc4cbd2d9</span>,</span><br><span class="line">    <span class="number">0xe0e7eef5</span>, <span class="number">0xfc030a11</span>, <span class="number">0x181f262d</span>, <span class="number">0x343b4249</span>,</span><br><span class="line">    <span class="number">0x50575e65</span>, <span class="number">0x6c737a81</span>, <span class="number">0x888f969d</span>, <span class="number">0xa4abb2b9</span>,</span><br><span class="line">    <span class="number">0xc0c7ced5</span>, <span class="number">0xdce3eaf1</span>, <span class="number">0xf8ff060d</span>, <span class="number">0x141b2229</span>,</span><br><span class="line">    <span class="number">0x30373e45</span>, <span class="number">0x4c535a61</span>, <span class="number">0x686f767d</span>, <span class="number">0x848b9299</span>,</span><br><span class="line">    <span class="number">0xa0a7aeb5</span>, <span class="number">0xbcc3cad1</span>, <span class="number">0xd8dfe6ed</span>, <span class="number">0xf4fb0209</span>,</span><br><span class="line">    <span class="number">0x10171e25</span>, <span class="number">0x2c333a41</span>, <span class="number">0x484f565d</span>, <span class="number">0x646b7279</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wd_to_byte</span>(<span class="params">wd, bys</span>):</span></span><br><span class="line">    bys.extend([(wd &gt;&gt; i) &amp; <span class="number">0xff</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>, -<span class="number">1</span>, -<span class="number">8</span>)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bys_to_wd</span>(<span class="params">bys</span>):</span></span><br><span class="line">    ret = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        bits = <span class="number">24</span> - i * <span class="number">8</span></span><br><span class="line">        ret |= (bys[i] &lt;&lt; bits)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">s_box</span>(<span class="params">wd</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    进行非线性变换，查S盒</span></span><br><span class="line"><span class="string">    :param wd: 输入一个32bits字</span></span><br><span class="line"><span class="string">    :return: 返回一个32bits字   -&gt;int</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    ret = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">4</span>):</span><br><span class="line">        byte = (wd &gt;&gt; (<span class="number">24</span> - i * <span class="number">8</span>)) &amp; <span class="number">0xff</span></span><br><span class="line">        row = byte &gt;&gt; <span class="number">4</span></span><br><span class="line">        col = byte &amp; <span class="number">0x0f</span></span><br><span class="line">        index = (row * <span class="number">16</span> + col)</span><br><span class="line">        ret.append(S_BOX[index])</span><br><span class="line">    <span class="keyword">return</span> bys_to_wd(ret)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rotate_left</span>(<span class="params">wd, bit</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param wd: 待移位的字</span></span><br><span class="line"><span class="string">    :param bit: 循环左移位数</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> (wd &lt;&lt; bit &amp; <span class="number">0xffffffff</span>) | (wd &gt;&gt; (<span class="number">32</span> - bit))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Linear_transformation</span>(<span class="params">wd</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    进行线性变换L</span></span><br><span class="line"><span class="string">    :param wd: 32bits输入</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> wd ^ rotate_left(wd, <span class="number">2</span>) ^ rotate_left(wd, <span class="number">10</span>) ^ rotate_left(wd, <span class="number">18</span>) ^ rotate_left(wd, <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Tx</span>(<span class="params">k1, k2, k3, ck</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    密钥扩展算法的合成变换</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    xor = k1 ^ k2 ^ k3 ^ ck</span><br><span class="line">    t = s_box(k1 ^ k2 ^ k3 ^ ck)</span><br><span class="line">    <span class="keyword">return</span> t ^ rotate_left(t, <span class="number">13</span>) ^ rotate_left(t, <span class="number">23</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">T</span>(<span class="params">x1, x2, x3, rk</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    加密算法轮函数的合成变换</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    t = x1 ^ x2 ^ x3 ^ rk</span><br><span class="line">    t = s_box(t)</span><br><span class="line">    <span class="keyword">return</span> t ^ rotate_left(t, <span class="number">2</span>) ^ rotate_left(t, <span class="number">10</span>) ^ rotate_left(t, <span class="number">18</span>) ^ rotate_left(t, <span class="number">24</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">key_extend</span>(<span class="params">main_key</span>):</span></span><br><span class="line">    MK = [(main_key &gt;&gt; (<span class="number">128</span> - (i + <span class="number">1</span>) * <span class="number">32</span>)) &amp; <span class="number">0xffffffff</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="comment"># 将128bits分为4个字</span></span><br><span class="line">    keys = [FK[i] ^ MK[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="comment"># 生成K0~K3</span></span><br><span class="line">    RK = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        t = Tx(keys[i + <span class="number">1</span>], keys[i + <span class="number">2</span>], keys[i + <span class="number">3</span>], CK[i])</span><br><span class="line">        k = keys[i] ^ t</span><br><span class="line">        keys.append(k)</span><br><span class="line">        RK.append(k)</span><br><span class="line">    <span class="keyword">return</span> RK</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">R</span>(<span class="params">x0, x1, x2, x3</span>):</span></span><br><span class="line">    <span class="comment"># 使用位运算符将数值限制在32位范围内</span></span><br><span class="line">    x0 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">    x1 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">    x2 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">    x3 &amp;= <span class="number">0xffffffff</span></span><br><span class="line">    s = <span class="string">f&quot;<span class="subst">&#123;x3:08x&#125;</span><span class="subst">&#123;x2:08x&#125;</span><span class="subst">&#123;x1:08x&#125;</span><span class="subst">&#123;x0:08x&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span>(<span class="params">plaintext, rk</span>):</span></span><br><span class="line">    X = [plaintext &gt;&gt; (<span class="number">128</span> - (i + <span class="number">1</span>) * <span class="number">32</span>) &amp; <span class="number">0xffffffff</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        t = T(X[<span class="number">1</span>], X[<span class="number">2</span>], X[<span class="number">3</span>], rk[i])</span><br><span class="line">        c = (t ^ X[<span class="number">0</span>])</span><br><span class="line">        X = X[<span class="number">1</span>:] + [c]</span><br><span class="line">    ciphertext = R(X[<span class="number">0</span>], X[<span class="number">1</span>], X[<span class="number">2</span>], X[<span class="number">3</span>])</span><br><span class="line">    <span class="comment"># 进行反序处理</span></span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode</span>(<span class="params">ciphertext, rk</span>):</span></span><br><span class="line">    ciphertext = <span class="built_in">int</span>(ciphertext, <span class="number">16</span>)</span><br><span class="line">    X = [ciphertext &gt;&gt; (<span class="number">128</span> - (i + <span class="number">1</span>) * <span class="number">32</span>) &amp; <span class="number">0xffffffff</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        t = T(X[<span class="number">1</span>], X[<span class="number">2</span>], X[<span class="number">3</span>], rk[<span class="number">31</span> - i])</span><br><span class="line">        c = (t ^ X[<span class="number">0</span>])</span><br><span class="line">        X = X[<span class="number">1</span>:] + [c]</span><br><span class="line">    m = R(X[<span class="number">0</span>], X[<span class="number">1</span>], X[<span class="number">2</span>], X[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output</span>(<span class="params">s, name</span>):</span></span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(s), <span class="number">2</span>):</span><br><span class="line">        out += s[i:i + <span class="number">2</span>] + <span class="string">&quot; &quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;name&#125;</span>:&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(out.strip())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output2</span>(<span class="params">s, name</span>):</span></span><br><span class="line">    out = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(s), <span class="number">2</span>):</span><br><span class="line">        out += <span class="built_in">chr</span>(<span class="built_in">eval</span>(<span class="string">&#x27;0x&#x27;</span>+s[i:i + <span class="number">2</span>]))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;name&#125;</span>&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(out, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="comment"># print(out)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    key = <span class="string">&#x27;4131313232333537343638393930305A&#x27;</span> </span><br><span class="line">    main_key = <span class="built_in">eval</span>(<span class="string">&#x27;0x&#x27;</span>+key)</span><br><span class="line">    rk = key_extend(main_key)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;解密:&quot;</span>)</span><br><span class="line">    cipher = <span class="string">&#x27;A27C84EDE57F4EDE9D977F6C69339F2752E6067920A2C3B7A6BE2B4A6231650C51160EF0A39807DD8F40CF021D482310&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(cipher) // <span class="number">32</span>):</span><br><span class="line">        ciphertext = cipher[<span class="number">32</span>*i: <span class="number">32</span>*(i+<span class="number">1</span>)]</span><br><span class="line">        <span class="comment"># print(ciphertext)</span></span><br><span class="line">        m = decode(ciphertext, rk)</span><br><span class="line">        output2(m, <span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>出来的结果为：**<code>flag&#123;eb83c643-d0ee-4db6-bc35-96e11283bd21&#125;</code>**</p>
<hr>
<h1 id="REVERSE02"><a href="#REVERSE02" class="headerlink" title="REVERSE02"></a>REVERSE02</h1><p>这道题比较简单，根据提示，这道题应该有4层加密。</p>
<p>拖入ida中查看，发现对字符串格式进行了校验，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/10/44383559dc619edd.png" alt="格式校验部分" data-caption="格式校验部分" loading="lazy"></p>
<p>同时根据赛题提示与伪代码的分析，发现有4层简单加密，如下图：</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="https://c.img.dasctf.com/LightPicture/2024/10/2e3f958e35e833c5.png" alt="4层加密" data-caption="4层加密" loading="lazy"></p>
<h2 id="加密分析"><a href="#加密分析" class="headerlink" title="加密分析"></a>加密分析</h2><p><strong>第一层</strong>加密:</p>
<p>将字符串的前8位左移1位加密。</p>
<p><strong>第二层</strong>加密：</p>
<p>就是将字符串的第9位到第16位与<code>XorrLord</code>进行异或，然后与下面这8字节数据进行校验：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x60</span>,<span class="number">0x58</span>,<span class="number">0x16</span>,<span class="number">0x47</span>,<span class="number">0x7d</span>,<span class="number">0x5c</span>,<span class="number">0x44</span>,<span class="number">0x5d</span></span><br></pre></td></tr></table></figure>

<p><strong>第三层</strong>加密：</p>
<p>将字符串的第17位到第24位进行换表base64加密，最后与<code>BFO1AjdmPmG</code>进行比较，映射表如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CDEFGHIJKLMNOPQRSTUVWXYZABabcdefghijklmnopqrstuvwxyz0123456789+/</span><br></pre></td></tr></table></figure>

<p><strong>第四层</strong>加密：</p>
<p>将字符串最后8位数据进行AES加密，密钥为<code>AesMasterAesMast</code>，最后与下面16字节数据进行比较：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xF</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0xE6</span>, <span class="number">0x58</span>, <span class="number">0x20</span>, <span class="number">0x9B</span>, <span class="number">0x3A</span>, <span class="number">0xD6</span>, <span class="number">0xE4</span>, <span class="number">0x18</span>, <span class="number">0x3F</span>, <span class="number">0xA7</span>, <span class="number">0x78</span>,<span class="number">0xA5</span>, <span class="number">0x82</span></span><br></pre></td></tr></table></figure>

<p>最后分别写出解密脚本，我这里从最后一层开始解密。（其实可以一个脚本全部写完，主要是懒得写了🥴）</p>
<h2 id="解密-1"><a href="#解密-1" class="headerlink" title="解密"></a>解密</h2><p><strong>第四层</strong>解密：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加密的 16 字节数据</span></span><br><span class="line">encrypted_data = <span class="built_in">bytes</span>([</span><br><span class="line">    <span class="number">0xF</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0xE6</span>,</span><br><span class="line">    <span class="number">0x58</span>, <span class="number">0x20</span>, <span class="number">0x9B</span>, <span class="number">0x3A</span>,</span><br><span class="line">    <span class="number">0xD6</span>, <span class="number">0xE4</span>, <span class="number">0x18</span>, <span class="number">0x3F</span>,</span><br><span class="line">    <span class="number">0xA7</span>, <span class="number">0x78</span>, <span class="number">0xA5</span>, <span class="number">0x82</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原密钥（16 字节）</span></span><br><span class="line">key = <span class="string">b&quot;AesMasterAesMast&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 AES 解密（ECB 模式）</span></span><br><span class="line">cipher = AES.new(key, AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密数据</span></span><br><span class="line">decrypted_data = cipher.decrypt(encrypted_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将解密后的数据按字节输出为十六进制</span></span><br><span class="line">hex_output = <span class="string">&quot; &quot;</span>.join(<span class="string">f&quot;<span class="subst">&#123;byte:02x&#125;</span>&quot;</span> <span class="keyword">for</span> byte <span class="keyword">in</span> decrypted_data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;解密后的十六进制数据:&quot;</span>, hex_output)</span><br></pre></td></tr></table></figure>

<p>得到<code>61 64 32 65 34 35 36 31</code></p>
<p>（其实上面的结果后面还会跟上8个8，但是根据源码分析，只有前8字节才有用）</p>
<p><strong>第三层</strong>解密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"># 示例的 base64 数据（替换为你的数据）</span><br><span class="line">encoded_data = <span class="string">&quot;BFO1AjdmPmG&quot;</span></span><br><span class="line"></span><br><span class="line"># 自定义的 base64 字符映射表</span><br><span class="line">custom_base64_table = <span class="string">&quot;CDEFGHIJKLMNOPQRSTUVWXYZABabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>  # 自定义映射表</span><br><span class="line">standard_base64_table = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span></span><br><span class="line"></span><br><span class="line"># 构建自定义 base64 解码表</span><br><span class="line">translation_table = str.maketrans(custom_base64_table, standard_base64_table)</span><br><span class="line">translated_data = encoded_data.translate(translation_table)</span><br><span class="line"></span><br><span class="line"># 检查并修复填充</span><br><span class="line">missing_padding = len(translated_data) % <span class="number">4</span></span><br><span class="line"><span class="keyword">if</span> missing_padding:</span><br><span class="line">    translated_data += <span class="string">&quot;=&quot;</span> * (<span class="number">4</span> - missing_padding)  # 添加必要的填充</span><br><span class="line"></span><br><span class="line"># 使用标准 base64 解码</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    decoded_data = base64.b64decode(translated_data)</span><br><span class="line">    # 将解码后的数据按字节转换为十六进制并逐个输出</span><br><span class="line">    hex_output = <span class="string">&quot; &quot;</span>.join(f<span class="string">&quot;&#123;byte:02x&#125;&quot;</span> <span class="keyword">for</span> byte in decoded_data)</span><br><span class="line">    print(<span class="string">&quot;解码后的十六进制数据:&quot;</span>, hex_output)</span><br><span class="line">except base64.binascii.Error as e:</span><br><span class="line">    print(<span class="string">&quot;解码错误:&quot;</span>, e)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>得到<code>64 33 35 62 37 66 36 61</code></p>
<p><strong>第二与第一层</strong>解密：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> str1[] = &#123;<span class="number">0x6A</span>,<span class="number">0x0C4</span>,<span class="number">0x0CC</span>,<span class="number">0x62</span>,<span class="number">0x0C2</span>,<span class="number">0x6E</span>,<span class="number">0x0CA</span>,<span class="number">0x0CA</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span> temp1[<span class="number">9</span>];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp1[i] = str1[i] &gt;&gt; <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>,temp1[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">char</span> str2[] = &#123;<span class="number">0x60</span>,<span class="number">0x58</span>,<span class="number">0x16</span>,<span class="number">0x47</span>,<span class="number">0x7d</span>,<span class="number">0x5c</span>,<span class="number">0x44</span>,<span class="number">0x5d</span>&#125;;</span><br><span class="line">	<span class="keyword">char</span>* xorr = <span class="string">&quot;XorrLord&quot;</span>;</span><br><span class="line">	<span class="keyword">char</span> temp2[<span class="number">9</span>];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp2[i] = str2[i] ^ xorr[i];</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>,temp2[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> test[] = &#123;<span class="number">0x35</span> ,<span class="number">0x62</span> ,<span class="number">0x66</span> ,<span class="number">0x31</span> ,<span class="number">0x61</span> ,<span class="number">0x37</span> ,<span class="number">0x65</span> ,<span class="number">0x65</span>&#125;;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> temp[<span class="number">9</span>];</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">	&#123;</span><br><span class="line">		temp[i] = test[i] &lt;&lt; <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;%x &quot;</span>,temp[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后依次连接以上四部分数据然后转成ascii码获取flag</p>
<p>最后将数据汇总转成flag即可：**<code>wdbflag&#123;5bf1a7ee87d51369d35b7f6aad2e4561&#125;</code>**</p>

    
  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>本文作者：</strong>Em_Lin<br>
        <strong>本文链接：</strong><a href="https://ermu0.cn/2024/11/05/reverse/ctf/2024wangdingctf-re/" title="https:&#x2F;&#x2F;ermu0.cn&#x2F;2024&#x2F;11&#x2F;05&#x2F;reverse&#x2F;ctf&#x2F;2024wangdingctf-re&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;ermu0.cn&#x2F;2024&#x2F;11&#x2F;05&#x2F;reverse&#x2F;ctf&#x2F;2024wangdingctf-re&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0 CN</a> 协议进行许可

        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
   
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/ctf/" rel="tag">ctf</a>
    
</div>
  
  

  
      <div class="nexmoe-post-footer">
          <script src="https://giscus.app/client.js"
    data-repo="nexmoe/nexmoe.com"
    data-repo-id="R_kgDOJI1XUA"
    data-category="General"
    data-category-id="DIC_kwDOJI1XUM4CU1nn"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="preferred_color_scheme"
    data-lang="en"
    data-loading="lazy"
    crossorigin="anonymous"
    async>
</script>

      </div>
  
</div></div><div class="nexmoe-post-right">    <div class="nexmoe-fixed">
        <div class="nexmoe-tool">

            

            
            
            <button class="mdui-fab catalog" style="overflow:unset;">
                <i class="nexmoefont icon-i-catalog"></i>
                <div class="nexmoe-toc">
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#REVERSE01"><span class="toc-number">1.</span> <span class="toc-text">REVERSE01</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JAVA%E5%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text">JAVA层分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Native%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">Native函数分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SM4%E5%AF%86%E9%92%A5%E6%89%A9%E5%B1%95"><span class="toc-number">1.2.1.</span> <span class="toc-text">SM4密钥扩展</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SM4%E8%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">SM4轮函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86"><span class="toc-number">1.3.</span> <span class="toc-text">解密</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#REVERSE02"><span class="toc-number">2.</span> <span class="toc-text">REVERSE02</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">加密分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86-1"><span class="toc-number">2.2.</span> <span class="toc-text">解密</span></a></li></ol></li></ol>
                </div>
            </button>
            

            

            <a href="#nexmoe-content" class="backtop toc-link" aria-label="Back To Top" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
        </div>
    </div>
</div></div><div id="nexmoe-footer"><!--!--></div><div id="nexmoe-search-space"><div class="search-container"><div class="search-header"><div class="search-input-container"><input class="search-input" type="text" placeholder="搜索" onInput="sinput();"></div><a class="search-close" onclick="sclose();">×</a></div><div class="search-body"></div></div></div><div><script src='https://sentry.mixcm.com/js-sdk-loader/affb515ef7b517cb3fc0dc63d65a9fc2.min.js' crossorigin="anonymous"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2058306854838448" crossorigin="anonymous"></script>
</div></body></html>